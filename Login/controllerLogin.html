<script>
  //Esucha si es seleccionado "olvide contraseña"
  var olvideContrasena = document.getElementById("olvideContraseña")
  olvideContrasena.addEventListener("click", 
  function(){
    event.preventDefault(); 
    vistaActual= "login" //Indica la vista actual
    let email = formularioInicio.email.value
    indexControllerOlvidoClave(email);
    
  });

  var user = "";
  var nombre = "";


  function controllerInicio(datosUser){
    event.preventDefault();
    var email = datosUser.email.value;
    var contrasena = datosUser.contrasena.value;
    
    if (validarcampos(email, contrasena)){
        validarUsuarioBakend(email, contrasena);
    }

    /*formularioNivel1.usuarioNivel1.value = datosUser.email.value;
    formularioNivel2.usuarioNivel2.value = datosUser.email.value;*/
  
  }


/* VALIDAR CAMPOS DE LOGIN
    Verifica que el campo email no este vacio o que sea un email valido.
    devuelve TRUE o FALSE
*/
  
  function validarcampos(email, contrasena){
  if (email== ""){
    alertaError("true", "Indique su email");
    return false;

  }else if (!ValidarEmail(email)){
    document.getElementById("imputInicioEmail").focus();
    alertaError("true", "Email no válido, no use mayúsculas en el email");
    return false;

  }else {
    alertaError("false", "");
    return true
    
  }
  
  alert("Validando datos, cambios desde el local")
}

/* VALIDAR USUARIO BAKEND
    Verifica si el usuario es nuevo o el email y contraseña están correcto. 
    Devuelve un objeto array con el resultado:
    Cuando el usuario es nuevo devuelve la siguiente respuesta: 
      resultado {
                  newUser: true,
                  login: false
                }
    Cuando el usuario no es nuevo y los datos son correctos
      usuario = {
                  nombre : Efrain Rojas,
                  perfil : Administrador,
                  email: efrainrojas19@gmail.com,
                  
                }
    Cuando el usuario no es nuevo y los datos son incorrectos retorna FALSE

   */

async function validarUsuarioBakend(email, contrasena){
  activarModal("spiner", "Verificando usuario...")
  var datosUser = {
    email: email,
    contrasena: contrasena
  }

  var resultado =  
  await google.script.run.
  withSuccessHandler(validarRespuestaBakendTrue).
  withFailureHandler(validarRespuestaBakendFalse).
  controllerLoginBackend(datosUser);
}

function validarRespuestaBakendFalse(error){
  activarModal("respuestaNegativa", error);
}


/*VALIDAR RESPUESTA BANKEND TRUE 
  -Recibe los datos del Bakend cuando la respuesta es TRUE.
  -Valida los siguiente: 
  1- Si el usuario es nuevo. Si es TRUE lo direcciona a registrar contraseña.
  2- Si los datos son incorrectos, devuelve un alert al login.
  3- Si los datos son correctos, lo direcciona a Home. 
*/
function validarRespuestaBakendTrue(datos){
  if(datos.newUser==true){
    llamadoDesde = "claveNueva"
    activarModal("false")
    mostrarContenido("claveNueva", "false");

  }else if (datos==false){
    activarModal("respuestaNegativa", "Datos no validos");

  }else if (datos){
    activarModal("false");
    alertaError("false", "");
    mostrarUsuario(datos.nombre);  
    habilitarAcessos(datos.perfil);
    mostrarContenido("home");
  }
  
}

    
function mostrarUsuario (usuario){
  var htmlUser = document.getElementById('user');
  htmlUser.innerHTML = usuario;

}


function habilitarAcessos(perfil){
  
  if (perfil == "administrador"){
    ocultarElementos("false", ".opcionNav");

  }else if (perfil == "promotor"){
    ocultarElementos("false", ".viewPromotor");

  }else if (perfil == "representante"){
    ocultarElementos("false", ".viewRepresentante");
  }
}

</script>
