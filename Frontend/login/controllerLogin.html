<script>
    //Esucha si es seleccionado "olvide contraseña"
    var olvideContrasena = document.getElementById("olvideContraseña")
    olvideContrasena.addEventListener("click", 
    function(){
      event.preventDefault();
      
      llamadoDesde= "olvideClave" //Indica desde donde es llamado el form de cambiarClave
      
      asegurarEmail();
    })
  
    function enfoInicialLogin(){
      enfocarCampo("imputInicioEmail");
    }
  
    var user = "";
    var nombre = "";
  
  
    function controllerInicio(datosUser){
      event.preventDefault();
      var email = datosUser.email.value;
      var contrasena = datosUser.contrasena.value;
      
      if (validarcampos(email, contrasena)){
          validarUsuarioBakend(email, contrasena);
      }
  
        formularioNivel1.usuarioNivel1.value = datosUser.email.value;
        formularioNivel2.usuarioNivel2.value = datosUser.email.value;
      
    }
  
  
  /* VALIDAR CAMPOS DE LOGIN
      Verifica que el campo email no este vacio o que sea un email valido.
      devuelve TRUE o FALSE
  */
    
    function validarcampos(email, contrasena){
    if (email== ""){
      alertaError("true", "Indique su email");
      return false;
  
    }else if (!ValidarEmail(email)){
      document.getElementById("imputInicioEmail").focus();
      alertaError("true", "Email no válido, no use mayúsculas en el email");
      return false;
  
    }else {
      alertaError("false", "");
      return true
      
    }
    alert("hasta aqui funciona")
    
  }
  
  /* VALIDAR USUARIO BAKEND
      Verifica si el usuario es nuevo o el email y contraseña están correcto. 
      Devuelve un objeto array con el resultado:
      Cuando el usuario es nuevo devuelve la siguiente respuesta: 
        resultado {
                    newUser: true,
                    login: false
                  }
      Cuando el usuario no es nuevo y los datos son correctos
        usuario = {
                    nombre : Efrain Rojas,
                    perfil : Administrador,
                    email: efrainrojas19@gmail.com,
                    
                  }
      Cuando el usuario no es nuevo y los datos son incorrectos retorna FALSE
  
     */
  var existe = false //Variable de simulacion de respuesta del Backend
  async function validarUsuarioBakend(email, contrasena){
    activarSpiner("true", "login")
    var datosUser = {
      email: email,
      contrasena: contrasena
    }
  
    /*Aqui codigo que valide si el usuario existe
      1. Simulación con un array y un bucle
      nota: borrar el array y bucle al conectar con Backend*/
      var emails = ["efrainrojas19@gmail.com", "jwrojas77@gmail.com", "transferenciasrojas@gmail.com", "leduar41@gmail.com"]
      emails.forEach(function(i) {
        switch (i){
          case email:
            existe = true;
        }
        
      });
  
    var resultado =  
    await google.script.run.
    withSuccessHandler(validarRespuestaBakendTrue).
    withFailureHandler(validarRespuestaBakendFalse).
    controllerLoginBackend(datosUser);
  }
  
  
  /*VALIDAR RESPUESTA BANKEND TRUE 
    -Recibe los datos del Bakend cuando la respuesta es TRUE.
    -Valida los siguiente: 
    1- Si el usuario es nuevo. Si es TRUE lo direcciona a registrar contraseña.
    2- Si los datos son incorrectos, devuelve un alert al login.
    3- Si los datos son correctos, lo direcciona a Home. 
  */
  function validarRespuestaBakendTrue(datos){
    activarSpiner("false", "login")
    
    if(existe==false){
        activarSpiner("false");
        ocultarElementos("false", ".respuestaNegativa");
        document.getElementById("msjBackend").innerHTML = "Su Email aun no a sido autorizado, comuniquese con Atención TR";
  
    }else if(datos.newUser==true){
      llamadoDesde = "claveNueva"
      activarModal("false", "#respuestaBackend")
      mostrarContenido("claveNueva", "false");
  
    }else if (datos==false){
      ocultarElementos("false", ".respuestaNegativa");
      document.getElementById("msjBackend").innerHTML = "Datos no validos"
      activarModal("true", "#respuestaBackend");
  
    }else if (datos){
      nombre = datos.nombre;
      user = datos.email;
      console.log(datos.nombre, datos.perfil);
      mostrarInicio(datos.nombre, datos.perfil);  
    }
      /*Reinicio de la variable q simula respuesta del backend
        Borrar al conectar con Backend*/
      existe = false
  }
  
  
  function validarRespuestaBakendFalse(error){
    ocultarElementos("false", ".respuestaNegativa");
    document.getElementById("msjBackend").innerHTML = error
    activarModal("true", "#respuestaBackend");
  }
  
  
  function mostrarInicio (nombre, perfil){
      //console.log(usuario);
     formularioNivel1.nombreUserNivel1.value = nombre;
      ocultarElementoInicio();
      mostrarBienvenida(nombre);  
      habilitarAcessos(perfil);
  
  }
  
  
  function ocultarElementoInicio(){
    activarModal("false", "#respuestaBackend");
    ocultarElemento("false", "botonResponsi");
    ocultarElemento("true", "formularioInicio");
    alertaError("false", "");
  }
  
      
  function mostrarBienvenida (usuario){
    var title = "<h6><span class = 'fw-bold'>Usuario:</span> "+ usuario + "</h6></br>";
    var cont = document.getElementById('user');
    cont.innerHTML = title;
    ocultarElemento("false", "nombreUsuario");
  
  }
  
  
  function habilitarAcessos(perfil){
    
    if (perfil == "administrador"){
      ocultarElementos("false", ".opcionNav");
  
    }else if (perfil == "promotor"){
      ocultarElementos("false", ".viewPromotor");
  
    }else if (perfil == "representante"){
      alert("mostrando elementos de representante")
      ocultarElementos("false", ".viewRepresentante");
  
    }
  }
  
   
  function mostrarFormClaveNueva(){
      limpiarForm("formClaveNueva")
      ocultarElemento("true", "formularioInicio" );
      ocultarElemento("false", "formClaveNueva" );
  
  }
  
  
  </script>
  