<script>
  //Almacenamiento de los elementos del formulario en variables
  var formCambioClave = document.getElementById("formRestablecerClave");
  var respuestaI = preguntasCambioClave.inputRespuesta1;
  var respuestaII = preguntasCambioClave.inputRespuesta2;
  var repuestaCambioClave = formRestablecerClave.imputCambioContrasena.value;
  var repuestaConfirmCambioClave = formRestablecerClave.imputConfirmarCambioContrasena.value;
  var inputRespuestaI = document.getElementById("inputRespuesta1");
  var inputRespuestaII = document.getElementById("inputRespuesta2");
  var inputClaveAnterior = document.getElementById("imputclaveAnterior");
  var inputCambioClave = document.getElementById("imputCambioContrasena");
  var inputConfiCambioClave = document.getElementById("imputConfirmarCambioContrasena");

  //Simulacion: preguntas del usuario traidas del banckend
  //(borrar al ser conectado con backen)
  var preguntaUno = "¿Cual es el nombre de Dios?"
  var respuestaUno = "Jehová"
  var preguntaDos = "¿Cual es tu color favorito?"
  var respuestaDos = "Rojo"

  //Valida que exista un usuario valido para cambio de contraseña
  function asegurarEmail(){
    var email = document.getElementById("imputInicioEmail").value

    if (email == ""){
      document.getElementById("imputInicioEmail").focus();
      alertaError("true", "Indique su email");
    }else if (!ValidarEmail(email)){
      document.getElementById("imputInicioEmail").focus();
      alertaError("true", "Email no válido, no use mayúsculas en el email");
    }else {
      alertaError("false", "");
      activarSpiner("true", "login")

      /*Aqui codigo que valide si el usuario es nuevo o existe
       1.Se realiza un array con datos para simular la consulta del Backend por medio de un bucle
       Nota: Borrar array y bucle al conectar con el Backend*/
       
      var emails = ["efrainrojas19@gmail.com", "jwrojas77@gmail.com", "transferenciasrojas@gmail.com", "leduar41@gmail.com"]
      var nuevo = ["false", "false", "false", "true"]

      var existe = "false"
      var usuarioNuevo = "false"
      var j = 0
      emails.forEach(function(i) {
        switch (i){
          case email:
          existe = "true"
        }
        
        switch (i+nuevo[j]){
          case email+"true":
          usuarioNuevo ="true"
        }
        j++
        
      });

      //Segun respuesta: carga formulario "nueva clave" o "cambio de clave"
      if (existe == "false"){
        setTimeout(function(){
          activarSpiner("false");
          ocultarElementos("false", ".respuestaNegativa");
          document.getElementById("msjBackend").innerHTML = "Su Email aun no a sido autorizado, comuniquese con Atención TR";},3000);

      }else if (usuarioNuevo == "true") {
        setTimeout(function(){ activarModal("false", "#respuestaBackend"); mostrarContenido("claveNueva", "false")},3000);
      }else{
        setTimeout(function(){activarModal("false", "#respuestaBackend"); mostrarContenido("olvideClave", "false")},3000);
      }
    }
  }

  /*Formulario: cambioClave
      1. Muestra primera parte de preguntas
      2. Al contestar las preguntas correctamente pasa al form cambio de clave*/
  function olvideClave(llamado, parte){

    //Reinicio del fomrulario preguntas
      limpiarForm("preguntasCambioClave");

    //Reinicio del fomrulario cambioClave
      limpiarForm("formRestablecerClave");

    //Muestra form preguntas o cambio contraseña segun la solcitud
    if (parte == "preguntas"){
      ocultarElemento("true","formularioInicio" );
      ocultarElemento("false", "preguntasCambioClave");
      document.getElementById("preguntaI").innerHTML = preguntaUno;
      document.getElementById("preguntaII").innerHTML = preguntaDos;
      alertaError("false", "");

    }else if ((llamado == "olvide") && (parte == "clave")){
      //Cambio a formulario pregunta sin campo "Clave anterior"
      ocultarElemento("true", "preguntasCambioClave" );
      ocultarElemento("true", "claveAnterior" );
      ocultarElemento("false", "formRestablecerClave" );
      alertaError("false", "");

    }else if ((llamado == "cambiar") && (parte == "clave")){
      //Cambio a formulario pregunta con campo "Clave anterior"
      ocultarElemento("true", "preguntasCambioClave" );
      ocultarElemento("false", "claveAnterior" );
      ocultarElemento("false", "formRestablecerClave" );
      alertaError("false", "");
    }

  }
  
  //Validacion preguntas: los campos que no queden vacios
  function validarCampos(form){

    event.preventDefault();
    if (respuestaI.value == ""){
      alertaError("true", "Indique una respuesta");
      enfocarCampo("inputRespuesta1");
    }else if(respuestaII.value == ""){
      alertaError("true", "Indique una respuesta");
      enfocarCampo("inputRespuesta2");
    }else{
      alertaError("false", "");
      activarSpiner("true", "cambioClaveRespuestas");

      //Dependiendo de la respuesta del backend envia mensaje de error o muestra form preguntas
      if ((respuestaI.value == respuestaUno) && (respuestaII.value == respuestaDos)){
        
        //Segun de donde sea llamado el form muestra campo de "contraseña anterior"
        
        if (llamadoDesde == "olvideClave"){
          setTimeout( function(){activarModal("false", "#respuestaBackend"); olvideClave("olvide", "clave")}, 3000);

        }else if (llamadoDesde == "cambiarClave"){
          setTimeout( function(){activarModal("false", "#respuestaBackend"); olvideClave("cambiar", "clave")}, 3000);
        }

      }else if (respuestaI.value != respuestaUno){
        setTimeout(respuestasIncorrectas, 3000);  
        
      }else if (respuestaII.value != respuestaDos){
        setTimeout(respuestasIncorrectas, 3000);
      }
    }
  }

  //Mensaje si la respuesta no son correctas
  function respuestasIncorrectas() {
    activarSpiner("false")
    ocultarElementos("false", ".respuestaNegativa");
    document.getElementById("msjBackend").innerHTML = "Sus respuestas no son correctas, tome en cuenta las mayúsculas y minúsculas"
  }

  //Validacion de longitud de clave
  function validarLongitudClave(){
    
    if ((inputCambioClave.value.length < 8) && (inputCambioClave.value != "") && (formCambioClave.hidden == false)){      alertaError ("true", "la contraseñas debe tener un minimo de 8 caracteres")
      inputCambioClave.classList.add("border-danger");
      enfocarCampo("imputCambioContrasena");

    }else if ((inputCambioClave.value != inputConfiCambioClave.value) && (inputConfiCambioClave.value != "")){
      alertaError ("true", "las contraseñas no coinciden");
      inputConfiCambioClave.classList.add("border-danger");
      enfocarCampo("imputConfirmarCambioContrasena"); 
      
    }else {
      alertaError ("false", "");
      inputCambioClave.classList.remove('border-danger');
      inputConfiCambioClave.classList.remove('border-danger');
    }
  }

  //Validacion de contraseña: los campos que no queden vacios
  var msjError = ""
  function valCampClaveNueva(){
    event.preventDefault();
    
    if((document.getElementById("claveAnterior").hidden == false) && (inputClaveAnterior.value == "")){
      alertaError ("true", "Indique su clave anterior");
      enfocarCampo("imputclaveAnterior");

    }else if (inputCambioClave.value == ""){
      alertaError ("true", "Indique una clave");
      enfocarCampo("imputCambioContrasena");

    }else if (inputConfiCambioClave.value == ""){
      alertaError ("true", "Confirme su clave");
      enfocarCampo("imputConfirmarCambioContrasena");  

    }else {
      activarSpiner("true", "cambioClave")
      activarModal("true", "#respuestaBackend");
      alertaError("false", "");

      //Si campo de contraseña esta disponible valida la contraseña anterior
      //Eliminar variables al crear conexion con Backend
      //Simulacion; Respuesta del backend
      var respuestaBackend =""
      var claveAnterior = "12345678"
      if (document.getElementById("claveAnterior").hidden == false){
        //Aqui Codigo del backen para validar contraseña anterior
        
        //Este if simula la validacion del Backend, eliminar al conectar con BD
        if(inputClaveAnterior.value != claveAnterior){
          msjError = "Su clave anterior esta errada"
          respuestaBackend = "false"
        }else{
          respuestaBackend = "true"
        }
      }else { //Eliminar este "else if" al hacer conexcion con banckend
        msjError = "No se pudo guardar su clave, intente de nuevo"
        respuestaBackend = "true"
      }
        
      //Envio de mensaje segun respuesta del Backend
      if (respuestaBackend == "true"){
        setTimeout(cambioClaveCorrecto,3000);
      }else if ((respuestaBackend == "false")){
        setTimeout(function(){cambioClaveErrado()},3000); 
      }
    }
  }

  //Mensaje si la clave fue guardada correctamente
  function cambioClaveCorrecto(){
    activarSpiner("false")
    ocultarElementos("false", ".respuestaPositiva");
    document.getElementById("msjBackend").innerHTML = "Su clave a sido cambiada exitosamente, su nueva clave ya esta disponible"
  }

  //Mensaje si la clave no fue guardada correctamente
  function cambioClaveErrado(error){
    activarSpiner("false")
    ocultarElementos("false", ".respuestaNegativa");
    document.getElementById("msjBackend").innerHTML = msjError
  }

  //Cierre del formulario al terminar o cancelar
  function cerrarCambioClave(){
    if (llamadoDesde == "olvideClave"){
      alertaError ("false", "");
      mostrarContenido("login", "false");
    document.getElementById("imputInicioContrasena").value = "";
    document.getElementById("imputInicioContrasena").type ="password"
    enfocarCampo("imputInicioContrasena");
    rechazarTerminos("verContraseñaLogin");

    }else if (llamadoDesde == "cambiarClave"){
      alertaError ("false", "");
      /*ocultarElemento("true", "preguntasCambioClave");
      ocultarElemento("true", "formRestablecerClave");*/
      mostrarContenido("home", "false");

    }
    

  }

</script>  