<script>
/*---------------------------------------------------------------------------------------------------
                                  Controller Visual
-----------------------------------------------------------------------------------------------------*/
/*Gestor de Contenido
    1. Colapsa boton en modo responsi
    2. Oculta todas las vistas de la App
    3. Muestra el elemento solicitado*/
  async function mostrarContenido(view, colapse){
    //Colapsa boton en modo responsi
    if ((window.innerWidth <= '990') && (colapse == "true")){
      clickBoton("botonResponsi");
    }

    //Oculta todas las vistas de la App
    ocultarElementos("true", ".viewsApp");
    alertaError("false", "")
    
    //Muestra el elemento solicitado
    //form clave nueva
    if (view == "login"){
      limpiarCampo("imputInicioContrasena");
      ocultarElemento('false', 'formularioInicio' );
      document.getElementById("imputInicioContrasena").type ="password"
      enfocarCampo("imputInicioContrasena");

    }else if (view == "home"){
      alertaError("false", "");  

    }else if (view == "claveNueva"){
      limpiarForm("formClaveNueva");
      ocultarElemento("false", "formClaveNueva" );
      alertaError("false", "");  

      //Clientes nivel 1
    }else if (view == "olvideClave"){
      limpiarForm("formRestablecerClave");
      olvideClave("olvide", "preguntas");
      document.getElementById("inputsClave").classList.add ("row")
      document.getElementById("inputsClave").classList.remove("col-md-6")
      document.getElementById("inputsClave").classList.add ("col-md-12")
      document.getElementById("cambioContraseña").classList.remove("col-md-12")
      document.getElementById("cambioContraseña").classList.add ("col-md-6")
      document.getElementById("confirmarCambioContraseña").classList.remove("col-md-12")
      document.getElementById("confirmarCambioContraseña").classList.add ("col-md-6")
      document.getElementById("encabezadoPreguntas").innerHTML = "Olvide contraseña"
      document.getElementById("encabezadoClaves").innerHTML = "Olvide contraseña" 

      //form cambio clave
    }else if (view == "cambioClave"){
      olvideClave("cambiar", "preguntas"); 
      document.getElementById("inputsClave").classList.remove ("row")
      document.getElementById("inputsClave").classList.remove("col-md-12")
      document.getElementById("inputsClave").classList.add ("col-md-6")
      document.getElementById("cambioContraseña").classList.remove("col-md-6")
      document.getElementById("cambioContraseña").classList.add ("col-md-12")
      document.getElementById("confirmarCambioContraseña").classList.remove("col-md-6")
      document.getElementById("confirmarCambioContraseña").classList.add ("col-md-12")
      document.getElementById("encabezadoPreguntas").innerHTML = "Cambiar contraseña"
      document.getElementById("encabezadoClaves").innerHTML = "Cambiar contraseña"  

    }else if(view == "tabN1"){
      activarSpiner("true", "tabClientes");
      google.script.run.withSuccessHandler(showData).getData(user);

    }else if(view == "tabN2"){
      activarSpiner("true", "tabClientes");
      google.script.run.withSuccessHandler(showData).getData(user);

    }else if(view == "formN1"){  
      ocultarElemento("false", "formularioNivel1");
      limpiarForm("formularioNivel1");
      enfocarCampo('nombreNivel1');
      var resul = await  google.script.run.withSuccessHandler(cargarListaPaises).withFailureHandler(mostrarError).getPaises();
    }else if(view == "formN2"){  
      ocultarElemento("false", "formularioNivel2");
      limpiarForm("formularioNivel2");
      enfocarCampo('listNombreNivel2');
      var resul = await  google.script.run.withSuccessHandler(cargarListaPaises).withFailureHandler(mostrarError).getPaises();  

      //Clientes nivel 2
    }else if (view == "cliente2"){
      conte = indexCliente2();
      //google.script.run.withSuccessHandler(showData).getData();
      
    }
 
  }
/*---------------------------------------------------------------------------------------------------
                                  Controller Utilidades
-----------------------------------------------------------------------------------------------------*/  

  //Mensaje de alerta desde form
  function alertaError (visualizar, texto){
    var alerta = document.getElementById('alertError');

    if(visualizar == "true"){
      alerta.hidden = false; 
       alerta.innerHTML = texto;

    }else if (visualizar == "false"){
        alerta.hidden = true; 
    }
  }

  //Ocultar un elemento a la vez por su ID
  function ocultarElemento(ocultar, elementId ){
    
    var element = document.getElementById(elementId);

      if(ocultar== 'true'){
        element.hidden = true;
      }else if (ocultar== 'false'){
        element.hidden = false;
      }
  }

  //Ocultar varios elementos a la vez por su clase
  function ocultarElementos(ocultar, elementClass){
    
    let elements = document.querySelectorAll(elementClass);
    elements.forEach(function(element) {
      if (ocultar == "false"){
        element.hidden = false;
      } else if (ocultar == "true"){
        element.hidden = true;
      }
    });
  }

  //Desactiva algun elemento por su ID
  function disactivarElement(desactivar, elementId){
    var button = document.getElementById(elementId);
    
    if(desactivar== 'true'){
      button.disabled = true;
    }else if (desactivar=='false'){
      button.disabled = false;
    }
     
  }


  //Enfoque a algun campo especifico
  function enfocarCampo(elementId){
    var elemento = document.getElementById(elementId);
      elemento.focus();
  }


  //Hacer click a un boton por su ID
  function clickBoton(elementId){
    var elemento = document.getElementById(elementId)
    elemento.click();
  }


  //Reiniciar formulario
  function limpiarForm(formulario){
    document.getElementById(formulario).reset()

    let passwordType = document.getElementById(formulario).querySelectorAll(".password");
    passwordType.forEach(function(input) {
      input.type = "password";
    });

    let borders = document.getElementById(formulario).querySelectorAll(".borde");
    borders.forEach(function(input) {
      input.classList.remove("border-danger");
    });
  }

  //Limpia un campo especefico
  function limpiarCampo(campoID){
    var input = document.getElementById(campoID)
    input.value = ""
    input.classList.remove("border-danger");
  }


  //Mostrar contraseña de un input
  function mostrarContrasena(elementClass){
    let elements = document.querySelectorAll(elementClass);
    elements.forEach(function(element) {
      if (element.type == "password" ){
        element.type = "text";
      }else {
        element.type = "password";
      }
        
    });

  }  

  //Valida que el Email escrito en input sea valido
  function ValidarEmail (email) {
    var emailPattern =  /^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/;
    return emailPattern.test(email); 
  } 

  // Scrip de bootstrap para validar campos
  (function validarform () {
    'use strict'

    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.querySelectorAll('.needs-validation')

    // Loop over them and prevent submission
    Array.prototype.slice.call(forms)
      .forEach(function (form) {
        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
          }

          form.classList.add('was-validated')
        }, false)
      })
  })()

/*---------------------------------------------------------------------------------------------------
                                  Controller Tabla
-----------------------------------------------------------------------------------------------------*/

  /*Carga de datos en tabla
    1. Busca los datos qu corresponden al usuario
    2. Carga los datos en la tabla
    3. desactiva spiner de carga*/
  function showData(dataArray){
    $(document).ready(function(){
    $('#data-table').DataTable({
          data: dataArray,
        //CHANGE THE TABLE HEADINGS BELOW TO MATCH WITH YOUR SELECTED DATA RANGE
        columns: [
          {"title":"Codigo"},
          {"title":"Nombre"},
          {"title":"Pais Origen"},
          {"title":"Celular"},
          {"title":"Email"},
          {"title":"TJ"},
          {"title":"Familiar"},
          {"title":"Conocido"},
          {"title":"Promotor"},
        ], stateSave: true,
    "bDestroy": true,
    responsive:true

      });

    //table.destroy();
    console.log("dataTable "+dataArray);

    switch(llamadoDesde){
      case "tabN1": 
        ocultarElementos("false", ".viewNivel1");
        break;
      case "tabN2": 
        ocultarElementos("false", ".viewNivel2");
        break;
    }
    
    activartable("true");
    activarSpiner("false");
    activarModal("false","#respuestaBackend");

    });

  }


  /*Mostrar tablas*/
  function activartable(activar){
    if(activar == "true"){
      ocultarElemento('false', 'tabla' );
    }else if(activar == "false"){
      ocultarElemento('true', 'tabla' );
    }
    
  }

/*---------------------------------------------------------------------------------------------------
                                  Controller Modal
-----------------------------------------------------------------------------------------------------*/

  //Muestra el modal por su ID
  function activarModal(mostrar, elementId){
    ocultarElementos("true", "modalElements")
    if (mostrar == "true"){
      $(elementId).modal('show');
    }else if (mostrar == "false"){
      $(elementId).modal('hide');
    }
    
  }

  /* Modal: gestiona el mensaje de actividad en Backend con el spiner*/
  function activarSpiner(activar, llamado){
    var spinnerMsj = document.getElementById("msjSpiner");
    ocultarElementos("true", ".modalElements"); 
    ocultarElementos("false", ".viewCarga");
    activarModal("true","#respuestaBackend");

    if ((activar == "true") && (llamado == "login")){
      spinnerMsj.innerHTML = "Verificando usuario..."

    }else if ((activar == "true") && (llamado == "cambioClaveRespuestas")){
      spinnerMsj.innerHTML = "Verificando respuestas..."

    }else if ((activar == "true") && (llamado == "cambioClave")){
      spinnerMsj.innerHTML = "Actualizando clave..."

    }else if ((activar == "true") && (llamado == "claveNueva")){
      spinnerMsj.innerHTML = "Creando clave y preguntas de seguridad..."        

    }else if ((activar == "true") && (llamado == "tabClientes")){
      spinnerMsj.innerHTML = "Cargando clientes..."

    }else if ((activar == "true") && (llamado == "formN1")){
      spinnerMsj.innerHTML = "Guardando cliente..."

    }else if (activar == "false"){
      ocultarElementos("true", ".viewCarga");
    } 
  }

  //Modal: Gestiona la salida del modal de respuesta del Backend
  var llamadoDesde = ""
  function respuestaBackendSalida (){
    if (llamadoDesde == "claveNueva"){
      mostrarContenido("login", "false")

    }else if (llamadoDesde == "olvideClave"){
      mostrarContenido("login", "false")

    }else if (llamadoDesde == "cambiarClave"){
      mostrarContenido("home", "false") 
    
    }else if (llamadoDesde == "formN1"){
      setTimeout(function(){cerrarFormN1()}, 500) 
    }
    
  }
  
  //Modal: Gestiona el mensaje de advertencia al intentar salir.
  var salida= "";
  function advertenciaSalida(form){
    //Mensaje: Segun de donde se quiera salir.
    if (form == "claveNueva"){
      salida= "claveNueva";
      document.getElementById("alertaMensaje").innerHTML = "¿Esta seguro de salir sin crear una clave?";

    }else if (form == "sistematr") {
      salida="sistematr";
      document.getElementById("alertaMensaje").innerHTML = "¿Esta seguro de cerrar sesión?";

    }else if (form == "formN1"){
      salida="formN1";
      document.getElementById("alertaMensaje").innerHTML = "¿Esta seguro de salir sin completar el registro?";

    }else if (form == "formN2"){
      salida="formN2";
      document.getElementById("alertaMensaje").innerHTML = "¿Esta seguro de salir sin completar el registro?";     

    //Form "cambiarClave" es llamado desde dos partes, por ello tiene un indicador diferente.
    }else if (llamadoDesde == "olvideClave"){
      salida="olvideClave";
      document.getElementById("alertaMensaje").innerHTML = "¿Esta seguro de salir sin restablecer su contraseña?";

    }else if (llamadoDesde == "cambiarClave"){
      salida="cambioClave";
      document.getElementById("alertaMensaje").innerHTML = "¿Esta seguro de salir sin cambiar su contraseña?";

    }
    // llama modal
    activarModal("true", "#modalAlertaSalida");

  }

  //Modal: Gestiona la salida del modal de advertencia
  function salidaCondicionada(){
    
    if (salida == "claveNueva"){
      cerrarNuevaContrasena("true")
      limpiarForm("formularioInicio");
      enfocarCampo("imputInicioEmail");
    }else if (salida == "sistematr"){
      cerrarSesion();
    }else if (salida == "olvideClave"){
      cerrarCambioClave();
    }else if (salida == "cambioClave"){
      cerrarCambioClave()
    }else if (salida == "formN1"){
      cerrarFormN1()
    }else if (salida == "formN2"){
      cerrarFormN2()
    }    
  }

/*---------------------------------------------------------------------------------------------------
                                  Codigo por ordenar
-----------------------------------------------------------------------------------------------------*/

//Descripcion: nivel 2
  function indexCliente2(){

    ocultarElemento('true', 'formularioNivel1' );  

    ocultarElemento('true', 'formularioNivel2' );  

    ocultarElemento('false', 'contenido' );

    activartable("true");
        
  }

  function indexCliente1Adm(){
    
    ocultarElemento('true', 'formularioNivel1' );  

    ocultarElemento('true', 'formularioNivel2' );  

    ocultarElemento('false', 'contenido' );  

    activartable("true");

    var cont="";

        cont+="<div class='row p-3'>";
        cont+=  "<div class='col-md-12 mb-2'>";
        cont+=     "<h3>Clientes Nivel 1</h3>";
        cont+=  "</div>";
        cont+="</div>";
        
        contenido.innerHTML = cont;
        google.script.run.withSuccessHandler(showData).getDataTodo();
        return cont;  
  }

  //Formulario: Nuevo cliente nivel 2
  function nuevoCliente2(tipo){
      ocultarElemento('true', 'formularioNivel1');
      ocultarElemento ('false', 'formularioNivel2' )
      ocultarElemento('true', 'contenido' );
      activartable("false");

      if (tipo == 'nuevo'){
        promoverClientNivel1('false')
        enfocarCampo('nombreNivel2')
      }else if (tipo == 'promover'){
        promoverClientNivel1('true')
        enfocarCampo('listNombreNivel2')
      };

  }
  

  function respuestasValidas() {
    ocultarElemento("true", "spinerCargaClave" );
    ocultarElemento("true", "preguntaCambioClave" );
    ocultarElemento("false", "restablecerClave" );
    alertaError("false", "");
  }


  function promoverClientNivel1(respuesta){
    
    var nombreNivel1 = document.getElementById('promoverNivel1');
    var nombreNuevo = document.getElementById('nombreNuevo');

    if (respuesta == 'true'){
      nombreNivel1.hidden= false;
      nombreNuevo.hidden= true;
    }else if (respuesta == 'false'){
      nombreNivel1.hidden= true;
      nombreNuevo.hidden= false;
    }
  }

</script>
