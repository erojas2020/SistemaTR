<script>
/*---------------------------------------------------------------------------------------------------
                                  Controller Visual
-----------------------------------------------------------------------------------------------------*/

/* Cambios luis
/*Gestor de Contenido
    1. Colapsa boton en modo responsi
    2. Oculta todas las vistas de la App
    3. Almacena la vista actual
    4. Muestra el elemento solicitado*/
  var vistaActual = "";   
  async function mostrarContenido(view, colapse){
    //Colapsa boton en modo responsi
    if (colapse == "true"){
      clickBoton("botonResponsi");
    }

    //Oculta todas las vistas de la App
    ocultarElementos("true", ".viewsApp");
    vistaActual = view; //Indica la vista actual

    //Muestra el elemento solicitado
    //form clave nueva
    switch (view){
      case "login":
        limpiarForm("formularioInicio");
        ocultarElementos("true", ".sesionApp");
        ocultarElemento('false', 'formularioInicio' );
        enfocarCampo("imputInicioEmail"); 
        break;
      case "home":
        ocultarElementos("false", ".home");
        break;    
      case "claveNueva":
        limpiarForm("formClaveNueva");
        ocultarElemento("false", "formClaveNueva" );  
        break
      //Clientes form Olvide Contraseña preguntas
      case "olvideClavePreguntas":
        limpiarForm("olvidoClavePregunta");
        ocultarElemento("false", "olvidoClavePregunta");
        enfocarCampo('inputRespuesta1');
        break
      //form Olvide Contraseña Claves
      case "olvideClaveContraseña":
        limpiarForm("formRestablecerClave");
        ocultarElemento("false", "formRestablecerClave");
        enfocarCampo('imputCambioContrasena');
        break;
      //form cambio clave
      case "cambioClavePreguntas":
        limpiarForm("preguntasCambioClave");
        ocultarElemento("false", "preguntasCambioClave");
        enfocarCampo('ClaveNuevaRespuesta1'); 
        break
      case "cambioClaveContraseña":
        limpiarForm("formCambiarClave");
        ocultarElemento("false", "formCambiarClave");
        enfocarCampo('ClaveNuevaAnterior'); 
        break  
      case "tabN1":
        activarModal("spiner", "Cargando usuarios");
        google.script.run.withSuccessHandler(showData).getData(document.getElementById("imputInicioEmail").value);
        break
      case "tabN2":
        activarModal("spiner", "Cargando usuarios");
        google.script.run.withSuccessHandler(showData).getData(user);
        break
      case "formN1":  
        ocultarElemento("false", "formularioNivel1");
        limpiarForm("formularioNivel1");
        formularioNivel1.usuarioNivel1.value = document.getElementById("imputInicioEmail").value;
        formularioNivel1.nombreUserNivel1.value = document.getElementById("user").innerText;
        enfocarCampo('nombreNivel1');
        var resul = await  google.script.run.withSuccessHandler(cargarListaPaises).withFailureHandler(mostrarError).getPaises();
        break
      case "formN2":  
        ocultarElemento("false", "formularioNivel2");
        limpiarForm("formularioNivel2");
        formularioNivel1.usuarioNivel2.value = document.getElementById("imputInicioEmail").value;
        formularioNivel1.nombreUserNivel2.value = document.getElementById("user").outerHTML;
        enfocarCampo('listNombreNivel2');
        var resul = await  google.script.run.withSuccessHandler(cargarListaPaises).withFailureHandler(mostrarError).getPaises();  
        break
      //Clientes nivel 2
      case "cliente2":
        conte = indexCliente2();
        break
    }
 
  }
/*---------------------------------------------------------------------------------------------------
                                  Controller Utilidades
-----------------------------------------------------------------------------------------------------*/  

  //Mensaje de alerta desde form
  function alertaError (visualizar, texto){
    var alerta = document.getElementById('alertError');

    if(visualizar == "true"){
      alerta.hidden = false; 
       alerta.innerHTML = texto;

    }else if (visualizar == "false"){
        alerta.hidden = true; 
    }
  }

  //Ocultar un elemento a la vez por su ID
  function ocultarElemento(ocultar, elementId ){
    
    var element = document.getElementById(elementId);

      if(ocultar== 'true'){
        element.hidden = true;
      }else if (ocultar== 'false'){
        element.hidden = false;
      }
  }

  //Ocultar varios elementos a la vez por su clase
  function ocultarElementos(ocultar, elementClass){
    
    let elements = document.querySelectorAll(elementClass);
    elements.forEach(function(element) {
      if (ocultar == "false"){
        element.hidden = false;
      } else if (ocultar == "true"){
        element.hidden = true;
      }
    });
  }

  //Desactiva algun elemento por su ID
  function disactivarElement(desactivar, elementId){
    var button = document.getElementById(elementId);
    
    if(desactivar== 'true'){
      button.disabled = true;
    }else if (desactivar=='false'){
      button.disabled = false;
    }
     
  }


  //Enfoque a algun campo especifico
  function enfocarCampo(elementId){
    var elemento = document.getElementById(elementId);
      elemento.focus();
  }


  //Hacer click a un boton por su ID
  function clickBoton(elementId){
    if (window.innerWidth <= '990'){
      var elemento = document.getElementById(elementId)
      elemento.click();
    }
  }


  //Reiniciar formulario
  function limpiarForm(formulario){
    document.getElementById(formulario).reset();

    let passwordType = document.getElementById(formulario).querySelectorAll(".password");
    passwordType.forEach(function(input) {
      input.type = "password";
    });

    let borders = document.getElementById(formulario).querySelectorAll(".borde");
    borders.forEach(function(input) {
      input.classList.remove("border-danger");
    });
  }

  //Limpia un campo especefico
  function limpiarCampo(campoID){
    var input = document.getElementById(campoID)
    input.value = ""
    input.classList.remove("border-danger");
  }


  //Mostrar contraseña de un input
  function mostrarContrasena(elementClass){
    let elements = document.querySelectorAll(elementClass);
    elements.forEach(function(element) {
      if (element.type == "password" ){
        element.type = "text";
      }else {
        element.type = "password";
      }
        
    });

  }  

  //Valida que el Email escrito en input sea valido
  function ValidarEmail (email) {
    var emailPattern =  /^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/;
    return emailPattern.test(email); 
  } 

  // Scrip de bootstrap para validar campos
  (function validarform () {
    'use strict'

    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.querySelectorAll('.needs-validation')

    // Loop over them and prevent submission
    Array.prototype.slice.call(forms)
      .forEach(function (form) {
        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
          }

          form.classList.add('was-validated')
        }, false)
      })
  })()

/*---------------------------------------------------------------------------------------------------
                                  Controller Tabla
-----------------------------------------------------------------------------------------------------*/

  /*Carga de datos en tabla
    1. Busca los datos qu corresponden al usuario
    2. Carga los datos en la tabla
    3. desactiva spiner de carga*/
  function showData(dataArray){
    activartable("true");
    $(document).ready(function(){
    $('#data-table').DataTable({
          data: dataArray,
        //CHANGE THE TABLE HEADINGS BELOW TO MATCH WITH YOUR SELECTED DATA RANGE
        columns: [
          {"title":"Codigo"},
          {"title":"Nombre"},
          {"title":"Pais Origen"},
          {"title":"Celular"},
          {"title":"Email"},
          {"title":"TJ"},
          {"title":"Familiar"},
          {"title":"Conocido"},
          {"title":"Promotor"},
        ], stateSave: true,
    "bDestroy": true,
    responsive:true

      });

    //table.destroy();
    console.log("dataTable "+dataArray);

    switch(vistaActual){
      case "tabN1": 
        ocultarElementos("false", ".viewNivel1");
        break;
      case "tabN2": 
        ocultarElementos("false", ".viewNivel2");
        break;
    }
    
    activarModal("false");

    });

  }


  /*Mostrar tablas*/
  function activartable(activar){
    if(activar == "true"){
      ocultarElemento('false', 'tabla' );
    }else if(activar == "false"){
      ocultarElemento('true', 'tabla' );
    }
    
  }

/*---------------------------------------------------------------------------------------------------
                                  Controller Modal
-----------------------------------------------------------------------------------------------------*/

  /**Gestion de modal
   * indicar el tipo de modal a mostrar (spiner, respuestaPositiva, respuestaNegativa, advertencia)
   * mensaje a mostrar
   */
  function activarModal(tipo, mensaje){
    ocultarElementos("true", ".modalElements")

    var respuestaBakckend = document.getElementById("msjBackend")
    respuestaBakckend.innerHTML = mensaje

    var advertencia = document.getElementById("alertaMensaje")
    advertencia.innerHTML = mensaje

    //Configuración del modal segun el tipo
    switch (tipo) {
      case "spiner":
        ocultarElementos("false", ".viewCarga");
        $("#respuestaBackend").modal('show');
        break;
      case "respuestaPositiva":
        ocultarElementos("false", ".respuestaPositiva");
        $("#respuestaBackend").modal('show');
        break;
      case "respuestaNegativa":
        ocultarElementos("false", ".respuestaNegativa");
        $("#respuestaBackend").modal('show');
        break;
      case "advertencia":
        $("#modalAlertaSalida").modal('show');
        break;
      default:
        $("#respuestaBackend").modal('hide');  
        $("#modalAlertaSalida").modal('hide');  
    }
    
  }

  /** Segun la vista actual
   *   Gestiona la salida del modal
   */ 
  function salidaModal(){
    
    switch (vistaActual) {
      case "claveNueva":
        mostrarContenido("login");
        activarModal("false");
        break;
      case "sistematr":
        mostrarContenido("login");
        activarModal("false");
        break;
      case "olvideClavePreguntas":  
      case "olvideClaveContraseña":
        mostrarContenido("login");
        activarModal("false");
        break;
      case "cambioClave":
        mostrarContenido("home");
        activarModal("false");
        break;
      case "cambioClavePreguntas":
      case "cambioClaveContraseña":
        mostrarContenido("home");
        activarModal("false");
        break;
      case "formN1":
        mostrarContenido("tabN1");
        break;
      case "formN2":
        mostrarContenido("tabN2");
        break;  
    }
      
  }

/*---------------------------------------------------------------------------------------------------
                                  Codigo por ordenar
-----------------------------------------------------------------------------------------------------*/

//Descripcion: nivel 2
  function indexCliente2(){

    ocultarElemento('true', 'formularioNivel1' );  

    ocultarElemento('true', 'formularioNivel2' );  

    ocultarElemento('false', 'contenido' );

    activartable("true");
        
  }

  function indexCliente1Adm(){
    
    ocultarElemento('true', 'formularioNivel1' );  

    ocultarElemento('true', 'formularioNivel2' );  

    ocultarElemento('false', 'contenido' );  

    activartable("true");

    var cont="";

        cont+="<div class='row p-3'>";
        cont+=  "<div class='col-md-12 mb-2'>";
        cont+=     "<h3>Clientes Nivel 1</h3>";
        cont+=  "</div>";
        cont+="</div>";
        
        contenido.innerHTML = cont;
        google.script.run.withSuccessHandler(showData).getDataTodo();
        return cont;  
  }

  //Formulario: Nuevo cliente nivel 2
  function nuevoCliente2(tipo){
      ocultarElemento('true', 'formularioNivel1');
      ocultarElemento ('false', 'formularioNivel2' )
      ocultarElemento('true', 'contenido' );
      activartable("false");

      if (tipo == 'nuevo'){
        promoverClientNivel1('false')
        enfocarCampo('nombreNivel2')
      }else if (tipo == 'promover'){
        promoverClientNivel1('true')
        enfocarCampo('listNombreNivel2')
      };

  }
  

  function respuestasValidas() {
    ocultarElemento("true", "spinerCargaClave" );
    ocultarElemento("true", "preguntaCambioClave" );
    ocultarElemento("false", "restablecerClave" );
    alertaError("false", "");
  }


  function promoverClientNivel1(respuesta){
    
    var nombreNivel1 = document.getElementById('promoverNivel1');
    var nombreNuevo = document.getElementById('nombreNuevo');

    if (respuesta == 'true'){
      nombreNivel1.hidden= false;
      nombreNuevo.hidden= true;
    }else if (respuesta == 'false'){
      nombreNivel1.hidden= true;
      nombreNuevo.hidden= false;
    }
  }

</script>
